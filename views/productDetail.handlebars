<div class="container my-4">
  <div class="card shadow">
    <div class="card-body">
      <h1 class="card-title">{{product.title}}</h1>
      <p class="card-text">{{product.description}}</p>
      <ul class="list-group list-group-flush mb-3">
        <li class="list-group-item"><b>Precio:</b> ${{product.price}}</li>
        <li class="list-group-item"><b>Código:</b> {{product.code}}</li>
        <li class="list-group-item"><b>Estado:</b> {{#if product.status}}Activo{{else}}Inactivo{{/if}}</li>
        <li class="list-group-item"><b>Stock:</b> {{product.stock}}</li>
        <li class="list-group-item"><b>Categoría:</b> {{product.category}}</li>
        <li class="list-group-item"><b>Imágenes:</b>
          <ul>
            {{#each product.thumbnails}}
            <li><img src="{{this}}" alt="Imagen del producto"></li>
            {{/each}}
          </ul>
        </li>
      </ul>
      <button class="btn btn-primary w-100" onclick="addToCart('{{product._id}}')">
        Agregar al carrito
      </button>
    </div>
  </div>
</div>

<script>
  async function addToCart(productId) {
    let cartId = localStorage.getItem('cartId');

    // Si no hay un carrito en localStorage, crear uno nuevo
    if (!cartId) {
        const response = await fetch('/api/carts', { method: 'POST' });
        const data = await response.json();
        if (data.status === 'success') {
            cartId = data.payload._id; // Asegúrate de usar el _id del carrito creado
            localStorage.setItem('cartId', cartId);
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo crear el carrito',
            });
            return;
        }
    }

    // Agregar el producto al carrito con una cantidad específica
    const quantity = 1; // Cambia este valor si deseas enviar una cantidad diferente
    try {
        const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quantity }), // Enviar la cantidad al backend
        });

        if (response.ok) {
            Swal.fire({
                icon: 'success',
                title: 'Producto agregado',
                text: 'El producto se agregó al carrito exitosamente',
            });
        } else {
            const error = await response.json();
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message,
            });
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo agregar el producto al carrito',
        });
    }
}
</script>